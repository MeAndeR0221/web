# __`三次握手（Three-way handshake）`__
通信双方的三次TCP(Transmission Control Protocol)报文段[^s]的交换过程，也就是通常所说的TCP连接建立实现的三次握手(Three-Way Handshake)过程。所谓的“三次握手”，是为了对每次发送的数据量进行跟踪与协商，确保数据段的发送和接收同步，根据所接收到的数据量而确认数据发送、接收完毕后何时撤消联系，并建立虚连接。
![[Pasted image 20220824224939.png]]
为了建立连接TCP连接，通信双方必须从对方了解如下信息：对方报文发送的开始序号、对方发送数据的缓冲区大小、能被接收的最大报文段长度MSS（Maximum Segment Size）、被支持的TCP选项。
当连接建立完成之后，则：
1. TCP连接的通信双方均可知道连接上对方将被发送的第一个字节的序列号（发给对方的确认号，A发给B的确认号就是B将发送的序列号，同样B也是）；
2. 双方均可知道连接上能发送的MSS，从而即可选取握手阶段双方交换的SYN报文和SYN+ACK报文中MSS选项中较小的值作为实际值；
3. 双方均可知道对方的接收缓冲区大小；
4. 双方均可知道对方能否使用SACK、窗口缩放等选项。
基于这些信息，双方即可建立一个TCP连接(x，y)并基于该连接开始报文段的传输。

1. 第一次握手：建立连接时，[客户端](https://baike.baidu.com/item/%E5%AE%A2%E6%88%B7%E7%AB%AF)发送[syn](https://baike.baidu.com/item/syn)包（seq=j）到[服务器](https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8)，并进入[SYN_SENT](https://baike.baidu.com/item/SYN_SENT)状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。
2. 第二次握手：服务器收到syn包，必须确认客户端的SYN（[ack](https://baike.baidu.com/item/ack)=j+1），同时自己也发送一个SYN包（seq=k），即SYN+ACK)包，此时服务器进入[SYN_RECV](https://baike.baidu.com/item/SYN_RECV)状态。
3. 第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入[ESTABLISHED](https://baike.baidu.com/item/ESTABLISHED)（TCP连接成功）状态，完成三次握手。

# __`四次挥手`__
对于一个已经建立的连接，TCP使用改进的四次挥手来释放连接（使用一个带有FIN附加标记的报文段）。TCP关闭连接的步骤如下：
1. 第一步，当主机A的应用程序通知TCP数据已经发送完毕时，TCP向主机B发送一个带有FIN附加标记的报文段（FIN表示英文finish）；
2. 第二步，主机B收到这个FIN报文段之后，并不立即用FIN报文段回复主机A，而是先向主机A发送一个确认序号ACK，同时通知自己相应的应用程序：对方要求关闭连接（先发送ACK的目的是为了防止在这段时间内，对方重传FIN报文段）；
3. 第三步，主机B的应用程序告诉TCP：我要彻底的关闭连接，TCP向主机A送一个FIN报文段；
4. 第四步，主机A收到这个FIN报文段后，向主机B发送一个ACK表示连接彻底释放。

[^s]:TCP提供的是一种面向连接的，可靠的字节流服务，TCP提供可靠性的一种重要的方式就是MSS。通过MSS，应用数据被分割成TCP认为最适合发送的数据块，由TCP传递给IP的信息单位称为报文段或段(segment)。代表一个TCP socket的结构体struct tcp_sock中有多个成员用于确定应用数据被分割成最大为多大的数据块较为合适(最大报文段长度MSS)。